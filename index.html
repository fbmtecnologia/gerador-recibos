<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gerador de Recibos EUROMIRELLA</title>
    <!-- Inclui Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclui a fonte Poppins e ícones Font Awesome -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* A cor primária do tema foi alterada para um cinza escuro/preto para impressão */
        body { font-family: 'Poppins', sans-serif; background-color: #f7f7f7; }
        .loader{border:4px solid #f3f3f3;border-top:4px solid #333;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;display:none}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilos de input aprimorados */
        .input-container {
            display: flex;
            align-items: center;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            background-color: #f9fafb;
        }
        .input-container:focus-within {
            border-color: #333; /* Foco em preto */
            box-shadow: 0 0 0 2px rgba(51, 51, 51, 0.5);
            background-color: #ffffff;
        }
        .input-container input, .input-container select, .input-container textarea {
            border: none;
            outline: none;
            box-shadow: none;
            padding: 0;
            width: 100%;
            background: transparent;
            color: #1f2937; /* Cor do texto padrão */
        }
        /* Estilo para input readonly (campo de número de recibo) */
        .input-container input[readonly] {
            cursor: default;
            font-weight: 600;
            color: #333;
            background-color: #f9fafb; 
        }

        .input-container input::placeholder, .input-container textarea::placeholder {
            color: #9ca3af;
        }
        .input-icon {
            color: #333; /* Ícones em preto */
            font-size: 1.25rem;
            margin-right: 0.75rem;
        }

        /* Estilos de impressão (Foco Totalmente em Preto/Branco e COMPRESSÃO) */
        @media print {
            /* Definindo página A4 com margens ZERO */
            @page { size: A4 portrait; margin: 0 !important; }
            html,body{width:100%;height:100%;margin:0 !important;padding:0 !important;overflow:hidden !important;background:#fff !important; color: #000 !important;}
            body>*:not(#receiptContainer){display:none !important}
            
            /* Ajustes de cor e padding do container principal */
            #receiptContainer { 
                color: #000 !important; 
                margin: 0 !important;
                padding: 10px !important; /* Mínimo de padding no container */
            }

            /* Estilo da Prévia (Borda) */
            #receiptPreview { 
                border-color: #000 !important; 
                color: #000 !important; 
                border-style: solid !important; 
                border-width: 1px !important; 
                padding: 15px !important; /* Padding interno da prévia para conteúdo */
                box-shadow: none !important; 
                min-height: auto !important;
            }
            
            /* Forçando a cor preta no texto */
            #receiptPreview .font-semibold, 
            #receiptPreview .text-black { 
                color: #000 !important; 
                font-weight: 600 !important;
            }

            #receiptPreview p {
                color: #000 !important;
                page-break-inside: avoid !important;
            }
            
            #receiptContainer{display:block !important;visibility:visible !important;position:absolute !important;left:0;top:0;width:100% !important;max-width:100% !important;height:auto !important;min-height:auto !important;margin:0 !important;padding:10px !important;box-shadow:none !important;border:none !important;page-break-after:avoid !important;page-break-inside:avoid !important}
            
            #logoImageContainer img{max-width:180px !important;max-height:90px !important;object-fit:contain !important;display:block !important;margin:0 auto 8px auto !important} /* Reduzido margem */
            #signatureImageContainer img{max-width:100px !important;max-height:50px !important;object-fit:contain !important;display:block !important;margin:2px auto 2px auto !important} /* Reduzido margem */
            
            /* AJUSTE CHAVE: Máxima compressão para a imagem do comprovante */
            #receiptImageContainer img{
                max-width:100% !important;
                max-height:480px !important; /* Reduzido para 480px para dar mais folga na página A4 */
                object-fit:contain !important;
                margin-top:8px !important; /* Margem reduzida */
            } 
            
            .no-print{display:none !important}
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col items-center justify-center p-6 min-h-screen">
    
    <!-- Formulário de Entrada -->
    <div id="inputFormContainer" class="bg-white p-10 rounded-2xl shadow-xl w-full max-w-2xl mb-8 no-print transform transition-transform duration-300 hover:scale-105">
        <h1 class="text-4xl font-bold text-center text-gray-900 mb-8 tracking-wide">Gerador de Recibos EUROMIRELLA ✨</h1>

        <!-- Seção de Moeda -->
        <div class="mb-6 border-b border-gray-200 pb-4">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Configuração Financeira</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="currencySelect" class="block text-gray-700 text-sm font-semibold mb-2">Moeda do Recibo:</label>
                    <div class="input-container">
                        <i class="fa-solid fa-coins input-icon"></i>
                        <select id="currencySelect" class="text-gray-800 transition duration-200">
                            <option value="BRL" selected>BRL — Real (R$)</option>
                            <option value="EUR">EUR — Euro (€)</option>
                            <option value="USD">USD — Dólar (US$)</option>
                            <option value="GBP">GBP — Libra (£)</option>
                            <option value="CUSTOM">Personalizada…</option>
                        </select>
                    </div>
                </div>
                <div id="custom-currency-inputs" class="md:col-span-2 hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="input-container">
                        <input id="customMajor" type="text" class="text-gray-800 placeholder-gray-400" placeholder="Nome da unidade (ex.: Lira, Rand)">
                    </div>
                    <div class="input-container">
                        <input id="customMinor" type="text" class="text-gray-800 placeholder-gray-400" placeholder="Subunidade (ex.: Kuruş, Centavos)">
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção de Imagens -->
        <div class="mb-6 border-b border-gray-200 pb-4">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Imagens (Opcional)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="logoImageInput" class="block text-gray-700 text-sm font-semibold mb-2">Logo:</label>
                    <input type="file" id="logoImageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-100 file:text-purple-700 hover:file:bg-purple-200 cursor-pointer transition duration-200"/>
                    <div id="logoPreviewContainer" class="mt-4 flex justify-center">
                        <img id="logoImagePreview" src="#" alt="Prévia da Logo" class="hidden max-w-full h-auto rounded-lg shadow-sm border border-gray-200"/>
                    </div>
                </div>
                <div>
                    <label for="signatureImageInput" class="block text-gray-700 text-sm font-semibold mb-2">Assinatura:</label>
                    <input type="file" id="signatureImageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 cursor-pointer transition duration-200"/>
                    <div id="signaturePreviewContainer" class="mt-4 flex justify-center">
                        <img id="signatureImagePreview" src="#" alt="Prévia da Assinatura" class="hidden max-w-full h-auto rounded-lg shadow-sm border border-gray-200"/>
                    </div>
                </div>
                <div>
                    <label for="proofImageInput" class="block text-gray-700 text-sm font-semibold mb-2">Comprovante:</label>
                    <input type="file" id="proofImageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 cursor-pointer transition duration-200"/>
                    <div id="imagePreviewContainer" class="mt-4 flex justify-center">
                        <img id="proofImagePreview" src="#" alt="Prévia do Comprovante" class="hidden max-w-full h-auto rounded-lg shadow-sm border border-gray-200"/>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dados do Pagamento -->
        <div class="mb-6 border-b border-gray-200 pb-4">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Dados do Pagamento</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- CAMPO DE NÚMERO DE RECIBO (Automatico) -->
                <div>
                    <label for="receiptNumber" class="block text-gray-700 text-sm font-semibold mb-2">Número do Recibo:</label>
                    <div class="input-container bg-gray-100">
                        <i class="fa-solid fa-hashtag input-icon"></i>
                        <input type="text" id="receiptNumber" class="text-gray-800" readonly>
                    </div>
                </div>
                <!-- FIM CAMPO -->

                <div>
                    <label for="payerName" class="block text-gray-700 text-sm font-semibold mb-2">Nome Completo do Pagador:</label>
                    <div class="input-container">
                        <i class="fa-solid fa-user input-icon"></i>
                        <input type="text" id="payerName" class="text-gray-800 placeholder-gray-400" placeholder="Ex: Josenorio Alves Nunes">
                    </div>
                </div>
                <div>
                    <label for="paymentValue" id="paymentValueLabel" class="block text-gray-700 text-sm font-semibold mb-2">Valor Total do Pagamento (R$):</label>
                    <div class="input-container">
                        <i class="fa-solid fa-money-bill-wave input-icon"></i>
                        <!-- Input livre, sem formatação automática -->
                        <input type="text" id="paymentValue" class="text-gray-800 placeholder-gray-400" placeholder="Ex: 1397,00 ou 1.397,00">
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label for="paymentReason" class="block text-gray-700 text-sm font-semibold mb-2">Motivo do Pagamento:</label>
                    <div class="input-container items-start">
                        <i class="fa-solid fa-file-invoice input-icon mt-1"></i>
                        <textarea id="paymentReason" rows="4" class="text-gray-800 placeholder-gray-400 resize-y" placeholder="Ex: entrada de hospedagens na Europa, incluindo taxas, passeios e seguro viagem."></textarea>
                    </div>
                </div>
                <div>
                    <label for="paymentDate" class="block text-gray-700 text-sm font-semibold mb-2">Data do Pagamento:</label>
                    <div class="input-container">
                        <i class="fa-solid fa-calendar-day input-icon"></i>
                        <input type="date" id="paymentDate" class="text-gray-800">
                    </div>
                </div>
                <div>
                    <label for="paymentMethod" class="block text-gray-700 text-sm font-semibold mb-2">Forma de Pagamento:</label>
                    <div class="input-container">
                        <i class="fa-solid fa-credit-card input-icon"></i>
                        <!-- Opções de pagamento atualizadas -->
                        <select id="paymentMethod" class="text-gray-800 transition duration-200">
                            <option value="Transferência Bancária" selected>Transferência Bancária</option>
                            <option value="PIX">PIX</option>
                            <option value="Cartão de Crédito à vista">Cartão de Crédito à vista</option>
                            <option value="Cartão de Crédito em 2x">Cartão de Crédito em 2x</option>
                            <option value="Cartão de Crédito em 3x">Cartão de Crédito em 3x</option>
                            <option value="Cartão de Crédito em 4x">Cartão de Crédito em 4x</option>
                            <option value="Cartão de Crédito em 5x">Cartão de Crédito em 5x</option>
                            <option value="Cartão de Crédito em 6x">Cartão de Crédito em 6x</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dados da Empresa e Responsável -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Dados da Empresa e Responsável</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="receiverName" class="block text-gray-700 text-sm font-semibold mb-2">Nome da Empresa/Pessoa Recebedora:</label>
                    <div class="input-container">
                        <i class="fa-solid fa-building input-icon"></i>
                        <!-- Campo preenchido automaticamente, mas editável -->
                        <input type="text" id="receiverName" list="receiverNamesList" class="text-gray-800 placeholder-gray-400" placeholder="Ex: Euromirella Agência e Operadora de Turismo">
                    </div>
                    <datalist id="receiverNamesList"></datalist>
                </div>
                <div class="md:col-span-1">
                    <label for="signatoryInfo" class="block text-gray-700 text-sm font-semibold mb-2">Nome e Cargo do Responsável (para Assinatura):</label>
                    <div class="input-container">
                        <i class="fa-solid fa-signature input-icon"></i>
                        <!-- Campo preenchido automaticamente, mas editável -->
                        <input type="text" id="signatoryInfo" class="text-gray-800 placeholder-gray-400" placeholder="Ex: Mirella Meirelles, Diretora – EUROMIRELLA">
                    </div>
                </div>
            </div>
        </div>

        <!-- Botão de Impressão -->
        <div class="flex items-center justify-center">
            <button id="printReceiptBtn" class="bg-gray-800 hover:bg-black text-white font-bold py-3 px-8 rounded-full focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center shadow-lg">
                <i class="fa-solid fa-print mr-2"></i>Imprimir Recibo
                <div id="loader" class="loader ml-3"></div>
            </button>
        </div>
    </div>

    <!-- Prévia do Recibo -->
    <div id="receiptContainer" class="bg-white p-10 rounded-2xl shadow-xl w-full max-w-2xl">
        <h2 class="text-3xl font-bold text-center text-gray-900 mb-6 no-print">Prévia do Recibo</h2>
        <!-- Borda da prévia alterada para cinza -->
        <div id="receiptPreview" class="border-4 border-gray-300 border-dashed p-8 rounded-xl min-h-[400px] text-gray-900 leading-relaxed text-base fade-in"></div>
    </div>

    <!-- Rodapé com a Versão -->
    <footer class="mt-10 text-gray-500 text-xs text-center no-print">
        Versão 2.2.0
    </footer>

    <!-- Lógica JavaScript -->
    <script type="module">
        // ===== Configuração de moedas =====
        const currencyMap = {
            BRL: { code: 'BRL', locale: 'pt-BR', symbol: 'R$', majorSingular: 'real', majorPlural: 'reais', minorSingular: 'centavo', minorPlural: 'centavos' },
            EUR: { code: 'EUR', locale: 'pt-PT', symbol: '€', majorSingular: 'euro', majorPlural: 'euros', minorSingular: 'cêntimo', minorPlural: 'cêntimos' },
            USD: { code: 'USD', locale: 'en-US', symbol: 'US$', majorSingular: 'dólar', majorPlural: 'dólares', minorSingular: 'centavo', minorPlural: 'centavos' },
            GBP: { code: 'GBP', locale: 'en-GB', symbol: '£', majorSingular: 'libra', majorPlural: 'libras', minorSingular: 'penny', minorPlural: 'pence' }
        };

        // ===== Funções de Valor Por Extenso (pt) =====
        const unidades = ['zero','um','dois','três','quatro','cinco','seis','sete','oito','nove'];
        const especiais = ['dez','onze','doze','treze','quatorze','quinze','dezesseis','dezessete','dezoito','dezenove'];
        const dezenas = ['', '', 'vinte','trinta','quarenta','cinquenta','sessenta','setenta','oitenta','noventa'];
        const centenas = ['', 'cento','duzentos','trezentos','quatrocentos','quinhentos','seiscentos','setecentos','oitocentos','novecentos'];
        const grandezas = [
            ['', 'mil','milhões','bilhões','trilhões','quatrilhões','quintilhões','sextilhões','septilhões','octilhões','nonilhões','decilhões'],
            ['', 'milhões','milhões','bilhões','bilhões','trilhões','trilhões','quatrilhões','quatrilhões','quintilhões','quintilhões','decilhões']
        ];

        function converterTriade(num){
            if(num===0) return '';
            let s='', n=parseInt(num), c=Math.floor(n/100), d=Math.floor((n%100)/10), u=n%10;
            if(c===1 && d===0 && u===0){ s+='cem'; }
            else if(c>0){ s+=centenas[c]; }
            if(d>1){ s+=(s?' e ':'')+dezenas[d]; }
            else if(d===1){ s+=(s?' e ':'')+especiais[u]; u=0; }
            if(u>0){ s+=(s?' e ':'')+unidades[u]; }
            return s;
        }

        function valorPorExtensoComMoeda(valor, cfg){
            let [inteiro, centavos] = valor.toFixed(2).split('.').map(Number);
            let partes = [];
            if(inteiro===0 && centavos===0){ return `zero ${cfg.majorPlural}`; }
            
            if(inteiro>0){
                let temp = inteiro, blocos=[];
                while(temp>0){ blocos.push(temp%1000); temp=Math.floor(temp/1000); }
                for(let j=0;j<blocos.length;j++){
                    const b=blocos[j];
                    if(b>0){
                        let parte = converterTriade(b);
                        if(j===1){ parte = (b===1 && blocos[0]===0) ? 'mil' : (b===1 ? 'mil' : parte+' mil');
                        } else if(j>1){ parte += ' ' + (b===1 ? grandezas[0][j] : grandezas[1][j]); }
                        partes.unshift(parte.trim());
                    }
                }
                partes = partes.filter(Boolean);
                partes.push(inteiro===1 ? cfg.majorSingular : cfg.majorPlural);
            }
            if(centavos>0){
                if(inteiro>0) partes.push('e');
                partes.push(converterTriade(centavos));
                partes.push(centavos===1 ? cfg.minorSingular : cfg.minorPlural);
            }
            let out = partes.join(' ').replace(/\s+/g,' ').trim();
            if(out.startsWith('e ') && (inteiro===0 || centavos===0)){ out = out.substring(2); }
            return out;
        }

        // ===== Utilidades =====
        function showMessage(message, type='error'){
            const el=document.createElement('div');
            el.className='fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 px-6 py-4 rounded-lg shadow-lg z-50 text-center text-white';
            el.classList.add(type==='error'?'bg-red-500':(type==='success'?'bg-green-500':'bg-gray-700'));
            el.innerHTML=`<strong class="font-bold">${type==='error'?'Erro!':'Sucesso!'}</strong><span class="block sm:inline ml-2">${message}</span>`;
            document.body.appendChild(el);
            setTimeout(()=>el.remove(),3000);
        }
        
        function getTodayDate(){
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Função de limpeza de valor para aceitar formato pt-BR/EUA e converter para float
        function parseCurrencyInput(value){
            if(typeof value!=='string') return 0;
            let cleaned = value.trim();
            
            // Lógica: Assume que o último separador (vírgula ou ponto) é o decimal.
            let decimalSeparator = (cleaned.lastIndexOf(',') > cleaned.lastIndexOf('.')) ? ',' : '.';
            
            // 1. Remove todos os separadores de milhar (o oposto do decimal)
            let thousandSeparator = (decimalSeparator === '.') ? ',' : '.';
            cleaned = cleaned.replace(new RegExp('\\' + thousandSeparator, 'g'), '');

            // 2. Converte o separador decimal para ponto para uso com parseFloat
            cleaned = cleaned.replace(decimalSeparator, '.');
            
            // 3. Remove quaisquer caracteres não numéricos restantes (exceto o ponto decimal)
            cleaned = cleaned.replace(/[^\d.]/g, '');

            return parseFloat(cleaned)||0;
        }

        function saveToLocalStorage(key, value){
            try{ localStorage.setItem(key, JSON.stringify(value)); }
            catch(e){ console.error("Não foi possível salvar no localStorage.", e); }
        }

        function getFromLocalStorage(key){
            try{
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : null;
            }catch(e){
                console.error("Não foi possível carregar do localStorage.", e);
                return null;
            }
        }

        // ===== Controle de Numeração Sequencial =====
        const LAST_RECEIPT_KEY = 'last_receipt_info';

        function formatReceiptCount(count) {
            return String(count).padStart(3, '0');
        }

        // Retorna a informação do último recibo (ou o novo inicializado)
        function getReceiptNumberInfo() {
            const today = new Date();
            const currentYear = today.getFullYear();
            
            // { year: 2025, count: 15 } ou null
            let info = getFromLocalStorage(LAST_RECEIPT_KEY);

            // Se o ano mudou ou não há info, reinicia a contagem
            if (!info || info.year < currentYear) {
                // Inicia a contagem em 1 para o novo ano
                info = { year: currentYear, count: 1 };
                // Salva o novo valor para que o campo não fique vazio
                saveToLocalStorage(LAST_RECEIPT_KEY, info); 
            }
            
            return info;
        }

        // Retorna o número formatado para exibição (Ex: 015/2025)
        function getCurrentFormattedReceiptNumber(info) {
             const { year, count } = info;
             return `${formatReceiptCount(count)}/${year}`;
        }

        // Incrementa o contador e salva no localStorage APÓS a impressão
        function generateAndSaveNextReceiptNumber(currentInfo) {
            const nextCount = currentInfo.count + 1;
            const newInfo = { year: currentInfo.year, count: nextCount };
            saveToLocalStorage(LAST_RECEIPT_KEY, newInfo);
        }
        // ===== Fim Controle de Numeração Sequencial =====

        // ===== DOM refs e Constantes Fixas (Novas Regras) =====
        let payerNameInput, paymentValueInput, paymentReasonInput, paymentDateInput, paymentMethodInput, receiverNameInput, signatoryInfoInput, receiptNumberInput;
        let proofImageInput, proofImagePreview, logoImageInput, logoImagePreview, signatureImageInput, signatureImagePreview;
        let receiptPreviewDiv, printReceiptBtn, inputFormContainer, loader;
        let currencySelect, customMajorInput, customMinorInput, paymentValueLabel, receiverNamesDatalist, customCurrencyInputsDiv;

        let uploadedProofImageBase64=null, uploadedLogoBase64=null, uploadedSignatureBase64=null;

        // CONSTANTES FIXAS (Pode ser alterado pelo usuário e persistido)
        const DEFAULT_RECEIVER_NAME = "Euromirella Agência e Operadora de Turismo";
        const DEFAULT_SIGNATORY_INFO = "Mirella Meirelles - Diretora EUROMIRELLA";

        // Versão do Sistema
        const CURRENT_VERSION = "2.2.0";

        // Função para atualizar o campo do número do recibo e o preview
        function updateReceiptUI() {
            const currentInfo = getReceiptNumberInfo();
            const currentNumber = getCurrentFormattedReceiptNumber(currentInfo);
            receiptNumberInput.value = currentNumber;
            updateReceiptPreview(currentNumber);
        }

        function getCurrentCurrencyConfig(){
            const sel = currencySelect.value;
            if(sel==='CUSTOM'){
                const major = (customMajorInput.value||'moeda').trim();
                const minor = (customMinorInput.value||'centavos').trim();
                return {
                    code: 'XXX',
                    locale: 'pt-BR',
                    symbol: '',
                    majorSingular: major,
                    majorPlural: major.endsWith('s')?major:(major+'s'),
                    minorSingular: minor,
                    minorPlural: minor.endsWith('s')?minor:(minor+'s')
                };
            }
            return currencyMap[sel] || currencyMap.BRL;
        }

        function formatMoney(value, cfg){
            try{
                // Tenta formatar usando o código de moeda e locale
                return new Intl.NumberFormat(cfg.locale||'pt-BR', { style:'currency', currency: cfg.code||'BRL' }).format(value);
            }catch(e){
                // Fallback para formatação simples
                const base = new Intl.NumberFormat('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:2 }).format(value);
                return (cfg.symbol||'') + ' ' + base;
            }
        }

        function updateCurrencyLabel(){
            const cfg = getCurrentCurrencyConfig();
            const labelBase = 'Valor Total do Pagamento';
            const symbol = cfg.symbol ? ` (${cfg.symbol})` : '';
            paymentValueLabel.textContent = labelBase + symbol + ':';
        }

        function updateReceiptPreview(receiptNumberFromUI = null){
            const payerName = payerNameInput.value || '[Nome do Pagador]';
            const paymentValue = parseCurrencyInput(paymentValueInput.value);
            
            const paymentReason = paymentReasonInput.value || '[Motivo do Pagamento]';
            const paymentDate = paymentDateInput.value ? new Date(paymentDateInput.value+'T00:00:00').toLocaleDateString('pt-BR') : '[Data do Pagamento]';
            const paymentMethod = paymentMethodInput.value || '[Forma de Pagamento]';
            const receiverName = receiverNameInput.value || DEFAULT_RECEIVER_NAME;
            const signatoryInfo = signatoryInfoInput.value || DEFAULT_SIGNATORY_INFO;
            
            // Usa o número do recibo do campo de UI
            const receiptNumber = receiptNumberFromUI || receiptNumberInput.value || '[Número do Recibo]';

            const cfg = getCurrentCurrencyConfig();
            const valueExtenso = valorPorExtensoComMoeda(paymentValue, cfg);
            const formattedPaymentValue = formatMoney(paymentValue, cfg);

            const signatureContent = uploadedSignatureBase64
                ? `<div id="signatureImageContainer" class="flex justify-center mt-4 mb-2"><img src="${uploadedSignatureBase64}" alt="Assinatura" class="max-w-full h-auto"/></div>`
                : `<p class="text-center">_________________________________________</p>`;

            // Conteúdo do recibo em preto e branco
            receiptPreviewDiv.innerHTML = `
                ${uploadedLogoBase64 ? `<div id="logoImageContainer" class="mb-4 flex justify-center"><img src="${uploadedLogoBase64}" alt="Logo da Empresa" class="max-w-full h-auto rounded-lg shadow-sm"/></div>` : ''}
                <p class="text-right text-sm font-semibold mb-4 text-black">RECIBO No <span class="font-semibold text-black">${receiptNumber}</span></p>
                <p class="text-center font-bold text-lg mb-4 text-black">RECIBO DE PAGAMENTO</p>
                <p class="indent-8 text-justify text-black">
                    Recebemos de <span class="font-semibold text-black">${payerName}</span>, o valor de
                    <span class="font-semibold text-black">${formattedPaymentValue}</span> (${valueExtenso}),
                    referente à <span class="font-semibold text-black">${paymentReason}</span>. O pagamento foi realizado no dia
                    <span class="font-semibold text-black">${paymentDate}</span>, por meio de
                    <span class="font-semibold text-black">${paymentMethod}</span>, destinado à conta bancária da empresa
                    <span class="font-semibold text-black">${receiverName}</span>. Declaramos, para os devidos fins, que este recibo é
                    verdadeiro e corresponde ao valor efetivamente recebido.
                </p>
                <br>
                ${signatureContent}
                <p class="text-center text-black"><span class="font-semibold text-black">${signatoryInfo}</span></p>
                ${uploadedProofImageBase64 ? `<div id="receiptImageContainer" class="mt-4 flex justify-center"><img src="${uploadedProofImageBase64}" alt="Comprovante de Pagamento" class="max-w-full h-auto rounded-lg shadow-sm"/></div>` : ''}
                <div class="mt-4 text-xs italic text-gray-500 text-center">
                    <span>Gerado por: Gerador de Recibos EUROMIRELLA | Versão ${CURRENT_VERSION}</span>
                </div>
            `;
        }

        window.onload = function(){
            // refs
            payerNameInput = document.getElementById('payerName');
            paymentValueInput = document.getElementById('paymentValue');
            paymentReasonInput = document.getElementById('paymentReason');
            paymentDateInput = document.getElementById('paymentDate');
            paymentMethodInput = document.getElementById('paymentMethod');
            receiverNameInput = document.getElementById('receiverName');
            signatoryInfoInput = document.getElementById('signatoryInfo');
            receiverNamesDatalist = document.getElementById('receiverNamesList');
            customCurrencyInputsDiv = document.getElementById('custom-currency-inputs');
            // Referência para o novo campo de número do recibo
            receiptNumberInput = document.getElementById('receiptNumber');

            proofImageInput = document.getElementById('proofImageInput');
            proofImagePreview = document.getElementById('proofImagePreview');
            logoImageInput = document.getElementById('logoImageInput');
            logoImagePreview = document.getElementById('logoImagePreview');
            signatureImageInput = document.getElementById('signatureImageInput');
            signatureImagePreview = document.getElementById('signatureImagePreview');

            receiptPreviewDiv = document.getElementById('receiptPreview');
            printReceiptBtn = document.getElementById('printReceiptBtn');
            inputFormContainer = document.getElementById('inputFormContainer');
            loader = document.getElementById('loader');

            currencySelect = document.getElementById('currencySelect');
            customMajorInput = document.getElementById('customMajor');
            customMinorInput = document.getElementById('customMinor');
            paymentValueLabel = document.getElementById('paymentValueLabel');
            
            // Preenchimento inicial
            receiverNameInput.value = getFromLocalStorage('receiverName') || DEFAULT_RECEIVER_NAME;
            signatoryInfoInput.value = getFromLocalStorage('signatoryInfo') || DEFAULT_SIGNATORY_INFO;
            paymentDateInput.value = getTodayDate();
            
            // === NOVO REQUISITO: Forçar a contagem inicial para 102/AAAA (apenas se for o primeiro recibo do ano) ===
            const today = new Date();
            const currentYear = today.getFullYear();
            let currentInfoForInit = getFromLocalStorage(LAST_RECEIPT_KEY);

            // Se for o primeiro acesso OU se o contador foi resetado para 1 (início de ano), forçamos o início em 102.
            if (!currentInfoForInit || (currentInfoForInit.year === currentYear && currentInfoForInit.count === 1)) {
                const startCount = 102;
                // A contagem é o PRÓXIMO número a ser usado.
                const newInfo = { year: currentYear, count: startCount };
                saveToLocalStorage(LAST_RECEIPT_KEY, newInfo);
            }
            // === FIM NOVO REQUISITO ===

            // Gerenciamento dos nomes de recebedores
            let receiverNames = getFromLocalStorage('receiverNames') || [];
            function updateReceiverNamesDatalist(){
                receiverNamesDatalist.innerHTML = receiverNames.map(name => `<option value="${name}"></option>`).join('');
            }
            updateReceiverNamesDatalist();

            // Adicionar novo recebedor à lista
            receiverNameInput.addEventListener('blur', () => {
                const newName = receiverNameInput.value.trim();
                if (newName && !receiverNames.includes(newName)) {
                    receiverNames.push(newName);
                    saveToLocalStorage('receiverNames', receiverNames);
                    updateReceiverNamesDatalist();
                }
            });

            // listeners de campos
            [payerNameInput, paymentValueInput, paymentReasonInput, paymentDateInput, paymentMethodInput, receiverNameInput, signatoryInfoInput].forEach(i=>{
                // Atualiza a prévia, que puxa o número do recibo do campo
                i.addEventListener('input', () => updateReceiptPreview()); 
            });

            // Salvamento automático dos campos fixos (Persistência da alteração do default)
            receiverNameInput.addEventListener('input', (e) => saveToLocalStorage('receiverName', e.target.value));
            signatoryInfoInput.addEventListener('input', (e) => saveToLocalStorage('signatoryInfo', e.target.value));

            // moeda: alterna campos personalizados
            function toggleCustomFields(){
                const isCustom = currencySelect.value==='CUSTOM';
                customCurrencyInputsDiv.classList.toggle('hidden', !isCustom);
            }
            currencySelect.addEventListener('change', ()=>{ toggleCustomFields(); updateCurrencyLabel(); updateReceiptPreview(); });
            [customMajorInput, customMinorInput].forEach(i=> i.addEventListener('input', ()=>{ updateCurrencyLabel(); updateReceiptPreview(); }));

            // uploads de imagem (sem persistência para logo/assinatura)
            proofImageInput.addEventListener('change', e=>{
                const file=e.target.files[0];
                if(file){
                    const reader=new FileReader();
                    reader.onload = ev => { proofImagePreview.src=ev.target.result; proofImagePreview.classList.remove('hidden'); uploadedProofImageBase64=ev.target.result; updateReceiptPreview(); };
                    reader.onerror = ()=>{ showMessage("Erro ao carregar a imagem do comprovante.",'error'); uploadedProofImageBase64=null; updateReceiptPreview(); };
                    reader.readAsDataURL(file);
                } else {
                    proofImagePreview.src='#'; proofImagePreview.classList.add('hidden'); uploadedProofImageBase64=null; updateReceiptPreview();
                }
            });

            logoImageInput.addEventListener('change', e=>{
                const file=e.target.files[0];
                if(file){
                    const reader=new FileReader();
                    reader.onload = ev => { logoImagePreview.src=ev.target.result; logoImagePreview.classList.remove('hidden'); uploadedLogoBase64=ev.target.result; updateReceiptPreview(); };
                    reader.onerror = ()=>{ showMessage("Erro ao carregar a imagem da logo.",'error'); uploadedLogoBase64=null; updateReceiptPreview(); };
                    reader.readAsDataURL(file);
                } else {
                    logoImagePreview.src='#'; logoImagePreview.classList.add('hidden'); uploadedLogoBase64=null; updateReceiptPreview();
                }
            });

            signatureImageInput.addEventListener('change', e=>{
                const file=e.target.files[0];
                if(file){
                    const reader=new FileReader();
                    reader.onload = ev => { signatureImagePreview.src=ev.target.result; signatureImagePreview.classList.remove('hidden'); uploadedSignatureBase64=ev.target.result; updateReceiptPreview(); };
                    reader.onerror = ()=>{ showMessage("Erro ao carregar a imagem da assinatura.",'error'); uploadedSignatureBase64=null; updateReceiptPreview(); };
                    reader.readAsDataURL(file);
                } else {
                    signatureImagePreview.src='#'; signatureImagePreview.classList.add('hidden'); uploadedSignatureBase64=null; updateReceiptPreview();
                }
            });

            // imprimir (Lógica de numeração automática e nome de arquivo)
            printReceiptBtn.addEventListener('click', ()=>{
                const numericPaymentValue = parseCurrencyInput(paymentValueInput.value);
                
                if(!payerNameInput.value || isNaN(numericPaymentValue) || !paymentReasonInput.value || !paymentDateInput.value || !paymentMethodInput.value || !receiverNameInput.value || !signatoryInfoInput.value){
                    showMessage("Por favor, preencha todos os campos corretamente antes de imprimir o recibo.", 'error');
                    return;
                }

                // 1. Captura o número de recibo ATUAL para o arquivo
                const currentReceiptNumber = receiptNumberInput.value.replace('/', '-'); // Ex: 001-2025

                // 2. Prepara o nome do arquivo PDF (Número + Cliente + Resumo)
                // Limpa e resume o nome do pagador (máx 3 palavras)
                const clientName = payerNameInput.value
                    .replace(/[^a-zA-Z0-9\s]/g, '')
                    .trim()
                    .split(/\s+/)
                    .slice(0, 3)
                    .join('_')
                    .toUpperCase();
                
                // Limpa e resume a razão (máx 5 palavras)
                const reasonSummary = paymentReasonInput.value
                    .replace(/[^a-zA-Z0-9\s]/g, '')
                    .trim()
                    .split(/\s+/)
                    .slice(0, 5)
                    .join('_')
                    .toUpperCase();
                
                // Define o título temporário do documento para ser o nome do arquivo PDF
                const originalTitle = document.title;
                const newTitle = `RECIBO_${currentReceiptNumber}_${clientName}_${reasonSummary}`;

                document.title = newTitle;

                // Oculta UI e dispara a impressão
                inputFormContainer.classList.add('hidden');
                document.querySelector('#receiptContainer h2.no-print').classList.add('hidden');
                window.print();
                
                // 3. Restaura o título e salva o próximo número de sequência (APÓS a impressão)
                document.title = originalTitle;
                
                const currentInfo = getReceiptNumberInfo(); // Pega a info (que agora será 102/2025 ou mais)
                generateAndSaveNextReceiptNumber(currentInfo);
                
                // 4. Atualiza a UI para mostrar o próximo número de recibo (ex: 103/2025)
                updateReceiptUI();

                // Mostra UI de volta
                inputFormContainer.classList.remove('hidden');
                document.querySelector('#receiptContainer h2.no-print').classList.remove('hidden');
            });

            // init: Define o número do recibo na inicialização
            toggleCustomFields();
            updateCurrencyLabel();
            updateReceiptUI(); 
        };
    </script>
</body>
</html>